<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>stdio.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is a personal academic project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java:</a>
<a name="ln3">// https://pvs-studio.com</a>
<a name="ln4"> </a>
<a name="ln5">#include &lt;stdarg.h&gt;</a>
<a name="ln6">#include &lt;stdint.h&gt;</a>
<a name="ln7">#include &lt;stdio.h&gt;</a>
<a name="ln8">#include &lt;stdlib.h&gt;</a>
<a name="ln9">#include &lt;string.h&gt;</a>
<a name="ln10">#include &lt;syscalls.h&gt;</a>
<a name="ln11"> </a>
<a name="ln12">#define CURSOR_FREQ 10 /* Frecuencia en Ticks del dibujo del cursor*/</a>
<a name="ln13"> </a>
<a name="ln14">/**</a>
<a name="ln15"> * @brief Funcion auxiliar para printf y printfc</a>
<a name="ln16"> * @note La cantidad de parametros no es fija</a>
<a name="ln17"> * @param fmt Formato de lo que se desea escribir de STDOUT</a>
<a name="ln18"> * @param args lista de argumentos</a>
<a name="ln19"> */</a>
<a name="ln20">static void vprintf(char *fmt, va_list args);</a>
<a name="ln21"> </a>
<a name="ln22">void putchar(char c) { write(STDOUT, c); }</a>
<a name="ln23"> </a>
<a name="ln24">void putcharErr(char c) { write(STDERR, c); }</a>
<a name="ln25"> </a>
<a name="ln26">void puts(const char *s) {</a>
<a name="ln27">  while (*s)</a>
<a name="ln28">    putchar(*s++);</a>
<a name="ln29">}</a>
<a name="ln30"> </a>
<a name="ln31">void printErr(const char *s) {</a>
<a name="ln32">  while (*s)</a>
<a name="ln33">    putcharErr(*s++);</a>
<a name="ln34">}</a>
<a name="ln35"> </a>
<a name="ln36">int getchar() {</a>
<a name="ln37">  char c;</a>
<a name="ln38">  c = read(STDIN);</a>
<a name="ln39">  return c;</a>
<a name="ln40">}</a>
<a name="ln41"> </a>
<a name="ln42">char getScanCode() { return read(KBDIN); }</a>
<a name="ln43"> </a>
<a name="ln44">void printf(char *fmt, ...) {</a>
<a name="ln45">  va_list v;</a>
<a name="ln46">  va_start(v, fmt);</a>
<a name="ln47">  vprintf(fmt, v);</a>
<a name="ln48">  va_end(v);</a>
<a name="ln49">}</a>
<a name="ln50"> </a>
<a name="ln51">void vprintf(char *fmt, va_list args) {</a>
<a name="ln52">  char buffer[MAX_CHARS] = {0};</a>
<a name="ln53">  char *fmtPtr = fmt;</a>
<a name="ln54">  while (*fmtPtr) {</a>
<a name="ln55">    if (*fmtPtr == '%') {</a>
<a name="ln56">      fmtPtr++;</a>
<a name="ln57">      int dx = strtoi(fmtPtr, &amp;fmtPtr);</a>
<a name="ln58">      int len;</a>
<a name="ln59"> </a>
<a name="ln60">      switch (*fmtPtr) {</a>
<a name="ln61">      case 'c':</a>
<a name="ln62">        putchar(va_arg(args, int));</a>
<a name="ln63">        break;</a>
<a name="ln64">      case 'd':</a>
<a name="ln65">        len = itoa(va_arg(args, uint64_t), buffer, 10);</a>
<a name="ln66">        printNChars('0', dx - len);</a>
<a name="ln67">        puts(buffer);</a>
<a name="ln68">        break;</a>
<a name="ln69">      case 'x':</a>
<a name="ln70">        len = itoa(va_arg(args, uint64_t), buffer, 16);</a>
<a name="ln71">        printNChars('0', dx - len);</a>
<a name="ln72">        puts(buffer);</a>
<a name="ln73">        break;</a>
<a name="ln74">      case 's':</a>
<a name="ln75">        printNChars(' ', dx); // A diferencia %x y %d, la cantidad de espacios</a>
<a name="ln76">                              // es igual al numero</a>
<a name="ln77">        puts((char *)va_arg(args, char *));</a>
<a name="ln78">        break;</a>
<a name="ln79">      }</a>
<a name="ln80">    } else {</a>
<a name="ln81">      putchar(*fmtPtr);</a>
<a name="ln82">    }</a>
<a name="ln83">    fmtPtr++;</a>
<a name="ln84">  }</a>
<a name="ln85">}</a>
<a name="ln86"> </a>
<a name="ln87">void printfc(Color color, char *fmt, ...) {</a>
<a name="ln88">  Color prevColor = getFontColor();</a>
<a name="ln89">  setFontColor(color.r, color.g, color.b);</a>
<a name="ln90">  va_list args;</a>
<a name="ln91">  va_start(args, fmt);</a>
<a name="ln92">  vprintf(fmt, args);</a>
<a name="ln93">  va_end(args);</a>
<a name="ln94">  setFontColor(prevColor.r, prevColor.g, prevColor.b);</a>
<a name="ln95">}</a>
<a name="ln96"> </a>
<a name="ln97">void printNChars(char c, int n) {</a>
<a name="ln98">  for (int i = 0; i &lt; n; i++)</a>
<a name="ln99">    putchar(c);</a>
<a name="ln100">}</a>
<a name="ln101"> </a>
<a name="ln102">int scanf(char *fmt, ...) {</a>
<a name="ln103">  va_list v;</a>
<a name="ln104">  va_start(v, fmt);</a>
<a name="ln105">  char c;</a>
<a name="ln106">  int ticks = getTicks();</a>
<a name="ln107">  int cursorTicks = 0;</a>
<a name="ln108">  char cursorDrawn = 0;</a>
<a name="ln109">  char buffer[MAX_CHARS];</a>
<a name="ln110">  uint64_t bIdx = 0;</a>
<a name="ln111">  while ((c = getchar()) != '\n' &amp;&amp; bIdx &lt; MAX_CHARS - 1) {</a>
<a name="ln112">    cursorTicks = getTicks() - ticks;</a>
<a name="ln113">    if (cursorTicks &gt; CURSOR_FREQ) {</a>
<a name="ln114">      ticks = getTicks();</a>
<a name="ln115">      cursorTicks = 0;</a>
<a name="ln116">      if (cursorDrawn)</a>
<a name="ln117">        putchar('\b');</a>
<a name="ln118">      else</a>
<a name="ln119">        putchar('_');</a>
<a name="ln120">      cursorDrawn = !cursorDrawn;</a>
<a name="ln121">    }</a>
<a name="ln122">    if (c != 0) {</a>
<a name="ln123">      if (cursorDrawn) {</a>
<a name="ln124">        putchar('\b');</a>
<a name="ln125">        cursorDrawn = !cursorDrawn;</a>
<a name="ln126">      }</a>
<a name="ln127">      if (c != '\b') {</a>
<a name="ln128">        buffer[bIdx++] = c;</a>
<a name="ln129">        putchar(c);</a>
<a name="ln130">      } else if (bIdx &gt; 0) {</a>
<a name="ln131">        bIdx--;</a>
<a name="ln132">        putchar(c);</a>
<a name="ln133">      }</a>
<a name="ln134">    }</a>
<a name="ln135">  }</a>
<a name="ln136">  if (cursorDrawn)</a>
<a name="ln137">    putchar('\b');</a>
<a name="ln138">  putchar('\n');</a>
<a name="ln139">  buffer[bIdx] = 0;</a>
<a name="ln140">  char *fmtPtr = fmt;</a>
<a name="ln141">  char *end;</a>
<a name="ln142">  bIdx = 0;</a>
<a name="ln143"> </a>
<a name="ln144">  int qtyParams = 0;</a>
<a name="ln145">  while (*fmtPtr &amp;&amp; buffer[bIdx] &amp;&amp; bIdx &lt; MAX_CHARS) {</a>
<a name="ln146">    if (*fmtPtr == '%') {</a>
<a name="ln147">      fmtPtr++;</a>
<a name="ln148">      switch (*fmtPtr) {</a>
<a name="ln149">      case 'c':</a>
<a name="ln150">        *(char *)va_arg(v, char *) = buffer[bIdx];</a>
<a name="ln151">        end = &amp;buffer[bIdx] + 1;</a>
<a name="ln152">        break;</a>
<a name="ln153">      case 'd':</a>
<a name="ln154">        *(int *)va_arg(v, int *) = strtoi(&amp;buffer[bIdx], &amp;end);</a>
<a name="ln155">        break;</a>
<a name="ln156">      case 'x':</a>
<a name="ln157">        *(int *)va_arg(v, int *) = strtoh(&amp;buffer[bIdx], &amp;end);</a>
<a name="ln158">        break;</a>
<a name="ln159">      case 's':</a>
<a name="ln160">        end = &amp;buffer[bIdx] +</a>
<a name="ln161">              strcpychar((char *)va_arg(v, char *), &amp;buffer[bIdx], ' ');</a>
<a name="ln162">        break;</a>
<a name="ln163">      case 'S':</a>
<a name="ln164">        end = &amp;buffer[bIdx] +</a>
<a name="ln165">              strcpychar((char *)va_arg(v, char *), &amp;buffer[bIdx], '\n');</a>
<a name="ln166">        break;</a>
<a name="ln167">      }</a>
<a name="ln168">      bIdx += end - &amp;buffer[bIdx];</a>
<a name="ln169">      qtyParams++;</a>
<a name="ln170">    } else if (*fmtPtr == buffer[bIdx]) {</a>
<a name="ln171">      bIdx++;</a>
<a name="ln172">    } else {</a>
<a name="ln173">      printErr(&quot;Error!!!&quot;);</a>
<a name="ln174">    }</a>
<a name="ln175">    fmtPtr++;</a>
<a name="ln176">  }</a>
<a name="ln177">  buffer[bIdx - 1] = 0;</a>
<a name="ln178">  va_end(v);</a>
<a name="ln179">  return qtyParams;</a>
<a name="ln180">}</a>
<a name="ln181"> </a>
<a name="ln182">static char *_regNames[] = {&quot;RAX&quot;, &quot;RBX&quot;, &quot;RCX&quot;, &quot;RDX&quot;, &quot;RBP&quot;,</a>
<a name="ln183">                            &quot;RDI&quot;, &quot;RSI&quot;, &quot;R8&quot;,  &quot;R9&quot;,  &quot;R10&quot;,</a>
<a name="ln184">                            &quot;R11&quot;, &quot;R12&quot;, &quot;R13&quot;, &quot;R14&quot;, &quot;R15&quot;};</a>
<a name="ln185">void printRegisters(const uint64_t *rsp) {</a>
<a name="ln186">  for (int i = 0; i &lt; sizeof(_regNames) / sizeof(char *); i++)</a>
<a name="ln187">    printf(&quot;%s: 0x%x\n&quot;, _regNames[i],</a>
<a name="ln188">           rsp[sizeof(_regNames) / sizeof(char *) - i - 1]);</a>
<a name="ln189">}</a>
<a name="ln190"> </a>
<a name="ln191">const char *state_to_str(process_state_t st) {</a>
<a name="ln192">  switch (st) {</a>
<a name="ln193">  case PROC_READY:</a>
<a name="ln194">    return &quot;READY&quot;;</a>
<a name="ln195">  case PROC_RUNNING:</a>
<a name="ln196">    return &quot;RUN&quot;;</a>
<a name="ln197">  case PROC_BLOCKED:</a>
<a name="ln198">    return &quot;BLOCK&quot;;</a>
<a name="ln199">  case PROC_KILLED:</a>
<a name="ln200">    return &quot;KILLED&quot;;</a>
<a name="ln201">  }</a>
<a name="ln202">  return &quot;UNK&quot;;</a>
<a name="ln203">}</a>
</code></pre>
<div class="balloon" rel="145"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v781/" target="_blank">V781</a> The value of the 'bIdx' index is checked after it was used. Perhaps there is a mistake in program logic.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>