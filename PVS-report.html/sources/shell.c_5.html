<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>shell.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is a personal academic project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java:</a>
<a name="ln3">// https://pvs-studio.com</a>
<a name="ln4"> </a>
<a name="ln5"> </a>
<a name="ln6">#include &quot;./include/shell.h&quot;</a>
<a name="ln7">#include &quot;../../SharedLibraries/sharedStructs.h&quot;</a>
<a name="ln8">#include &quot;./include/inputParser.h&quot;</a>
<a name="ln9">#include &quot;./include/man.h&quot;</a>
<a name="ln10">#include &quot;./include/shellCommands.h&quot;</a>
<a name="ln11">#include &quot;./include/syscalls.h&quot;</a>
<a name="ln12">#include &quot;./include/test_functions.h&quot;</a>
<a name="ln13">#include &quot;stdio.h&quot;</a>
<a name="ln14">#include &quot;stdlib.h&quot;</a>
<a name="ln15">#include &quot;string.h&quot;</a>
<a name="ln16">#include &lt;libasm.h&gt;</a>
<a name="ln17">#include &lt;stddef.h&gt;</a>
<a name="ln18">#include &lt;stdint.h&gt;</a>
<a name="ln19">#include &lt;string.h&gt;</a>
<a name="ln20"> </a>
<a name="ln21">/* Enum para la cantidad de argumentos recibidos */</a>
<a name="ln22">typedef enum { NO_PARAMS = 0, SINGLE_PARAM, DUAL_PARAM } functionType;</a>
<a name="ln23"> </a>
<a name="ln24">#define QTY_BYTES 32 /* Cantidad de bytes de respuesta del printmem */</a>
<a name="ln25">#define DEFAULT_FONT_SIZE 1</a>
<a name="ln26">#define MIN_FONT_SIZE 1</a>
<a name="ln27">#define MAX_FONT_SIZE 3</a>
<a name="ln28"> </a>
<a name="ln29">#define WELCOME &quot;Bienvenido a Nuestro SO!\n&quot;</a>
<a name="ln30">#define INVALID_COMMAND &quot;Comando invalido!\n&quot;</a>
<a name="ln31">#define WRONG_PARAMS &quot;La cantidad de parametros ingresada es invalida\n&quot;</a>
<a name="ln32">#define INVALID_FONT_SIZE &quot;Dimension invalida de fuente\n&quot;</a>
<a name="ln33">#define CHECK_MAN &quot;Escriba \&quot;man %s\&quot; para ver como funciona el comando\n&quot;</a>
<a name="ln34">#define CHECK_MAN_FONT                                                         \</a>
<a name="ln35">  &quot;Escriba \&quot;man font-size\&quot; para ver las dimensiones validas\n&quot;</a>
<a name="ln36"> </a>
<a name="ln37">typedef struct {</a>
<a name="ln38">  char *name;        // Nombre del comando</a>
<a name="ln39">  char *description; // Descripcion del comando (para help)</a>
<a name="ln40">  entry_point_t f;</a>
<a name="ln41">} Command;</a>
<a name="ln42"> </a>
<a name="ln43">static void help(int argc, char **argv);</a>
<a name="ln44">static void man(int argc, char **argv);</a>
<a name="ln45">static void printInfoReg(int argc, char **argv);</a>
<a name="ln46">static void time(int argc, char **argv);</a>
<a name="ln47">static void div(int argc, char **argv);</a>
<a name="ln48">static void fontSize(int argc, char **argv);</a>
<a name="ln49">static void printMem(int argc, char **argv);</a>
<a name="ln50">static int getCommandIndex(char *command);</a>
<a name="ln51">static void create_single_process(input_parser_t *parser);</a>
<a name="ln52"> </a>
<a name="ln53">const static Command commands[] = {</a>
<a name="ln54">    {&quot;help&quot;, &quot;Listado de comandos&quot;, (entry_point_t)help},</a>
<a name="ln55">    {&quot;man&quot;, &quot;Manual de uso de los comandos&quot;, (entry_point_t)man},</a>
<a name="ln56">    {&quot;inforeg&quot;, &quot;Informacion de los registos capturados&quot;,</a>
<a name="ln57">     (entry_point_t)printInfoReg},</a>
<a name="ln58">    {&quot;time&quot;, &quot;Despliega la hora actual UTC - 3&quot;, (entry_point_t)time},</a>
<a name="ln59">    {&quot;div&quot;, &quot;Division entera de dos numeros naturales&quot;, (entry_point_t)div},</a>
<a name="ln60">    {&quot;kaboom&quot;, &quot;Ejecuta una excepcion de Invalid Opcode&quot;,</a>
<a name="ln61">     (entry_point_t)kaboom},</a>
<a name="ln62">    {&quot;font-size&quot;, &quot;Cambia dimensiones de la fuente&quot;, (entry_point_t)fontSize},</a>
<a name="ln63">    {&quot;printmem&quot;, &quot;Vuelco de memoria de 32 bytes desde direccion dada&quot;,</a>
<a name="ln64">     (entry_point_t)printMem},</a>
<a name="ln65">    {&quot;clear&quot;, &quot;Limpia toda la pantalla&quot;, (entry_point_t)clear},</a>
<a name="ln66">    {&quot;test-mm&quot;, &quot;Corre el test del memory manager&quot;, (entry_point_t)test_mm},</a>
<a name="ln67">    {&quot;test-processes&quot;, &quot;Corre el test de procesos&quot;,</a>
<a name="ln68">     (entry_point_t)test_processes},</a>
<a name="ln69">    {&quot;test-prio&quot;, &quot;Corre el test de prioridades&quot;, (entry_point_t)test_prio},</a>
<a name="ln70">    {&quot;test-sync&quot;, &quot;Corre el test de sincronizacion&quot;, (entry_point_t)test_sync},</a>
<a name="ln71">    {&quot;ps&quot;, &quot;Muestra informacion de los procesos&quot;, (entry_point_t)cmd_ps},</a>
<a name="ln72">    {&quot;mem&quot;, &quot;Muestra informacion del uso de memoria&quot;, (entry_point_t)cmd_mem},</a>
<a name="ln73">    {&quot;loop&quot;,</a>
<a name="ln74">     &quot;Imprime su ID con un saludo cada una determinada cantidad de segundos&quot;,</a>
<a name="ln75">     (entry_point_t)cmd_loop},</a>
<a name="ln76">    {&quot;kill&quot;, &quot;Mata un proceso dado su ID&quot;, (entry_point_t)cmd_kill},</a>
<a name="ln77">    {&quot;nice&quot;,</a>
<a name="ln78">     &quot;Cambia la prioridad de un proceso dado su ID y la nueva prioridad&quot;,</a>
<a name="ln79">     (entry_point_t)cmd_nice},</a>
<a name="ln80">    {&quot;block&quot;, &quot;Bloquea o desbloquea un proceso dado su ID&quot;,</a>
<a name="ln81">     (entry_point_t)cmd_block},</a>
<a name="ln82">    {&quot;unblock&quot;, &quot;Desbloquea un proceso dado su ID&quot;, (entry_point_t)cmd_unblock},</a>
<a name="ln83">    {&quot;cat&quot;, &quot;Imprime el stdin tal como lo recibe&quot;, (entry_point_t)cmd_cat},</a>
<a name="ln84">    {&quot;wc&quot;, &quot;Cuenta la cantidad de l√≠neas del input&quot;, (entry_point_t)cmd_wc},</a>
<a name="ln85">    {&quot;filter&quot;, &quot;Filtra las vocales del input&quot;, (entry_point_t)cmd_filter}};</a>
<a name="ln86"> </a>
<a name="ln87">void run_shell() {</a>
<a name="ln88">  puts(WELCOME);</a>
<a name="ln89">  while (1) {</a>
<a name="ln90">    putchar('&gt;');</a>
<a name="ln91">    char raw_input[MAX_CHARS] = {0};</a>
<a name="ln92">    scanf(&quot;%S&quot;, raw_input);</a>
<a name="ln93">    input_parser_t *parser = parse_input(raw_input);</a>
<a name="ln94">    if (parser == NULL) {</a>
<a name="ln95">      printErr(INVALID_COMMAND);</a>
<a name="ln96">      continue;</a>
<a name="ln97">    }</a>
<a name="ln98"> </a>
<a name="ln99">    if (parser-&gt;qty_shell_programs == 1) {</a>
<a name="ln100">      create_single_process(parser);</a>
<a name="ln101">    } </a>
<a name="ln102">    free_parser(parser);</a>
<a name="ln103">  }</a>
<a name="ln104">}</a>
<a name="ln105"> </a>
<a name="ln106">static void create_single_process(input_parser_t *parser) {</a>
<a name="ln107">  shell_program_t *program = parser-&gt;shell_programs[0];</a>
<a name="ln108">  int idx = getCommandIndex(program-&gt;name);</a>
<a name="ln109">  if (idx == -1) {</a>
<a name="ln110">    printErr(INVALID_COMMAND);</a>
<a name="ln111">    return;</a>
<a name="ln112">  }</a>
<a name="ln113">  if (parser-&gt;background) {</a>
<a name="ln114">    // VER!!</a>
<a name="ln115">  } else {</a>
<a name="ln116">    int16_t pid = my_create_process((entry_point_t)commands[idx].f,</a>
<a name="ln117">                                    program-&gt;params, program-&gt;name, NULL);</a>
<a name="ln118">    my_wait_pid(pid, NULL);</a>
<a name="ln119">  }</a>
<a name="ln120">}</a>
<a name="ln121"> </a>
<a name="ln122">/**</a>
<a name="ln123"> * @brief  Devuelve el indice del vector de comandos dado su nombre</a>
<a name="ln124"> * @param  command: Nombre del comando a buscar</a>
<a name="ln125"> * @return  Indice del comando</a>
<a name="ln126"> */</a>
<a name="ln127">static int getCommandIndex(char *command) {</a>
<a name="ln128">  int idx = 0;</a>
<a name="ln129">  for (; idx &lt; QTY_COMMANDS; idx++) {</a>
<a name="ln130">    if (!strcmp(commands[idx].name, command))</a>
<a name="ln131">      return idx;</a>
<a name="ln132">  }</a>
<a name="ln133">  return -1;</a>
<a name="ln134">}</a>
<a name="ln135"> </a>
<a name="ln136">static void help(int argc, char **argv) {</a>
<a name="ln137">  if (argc != 1) {</a>
<a name="ln138">    printErr(WRONG_PARAMS);</a>
<a name="ln139">    return;</a>
<a name="ln140">  }</a>
<a name="ln141">  for (int i = 0; i &lt; QTY_COMMANDS; i++)</a>
<a name="ln142">    printf(&quot;%s: %s\r\n&quot;, commands[i].name, commands[i].description);</a>
<a name="ln143">}</a>
<a name="ln144"> </a>
<a name="ln145">static void div(int argc, char **argv) {</a>
<a name="ln146">  if (argc != 3) {</a>
<a name="ln147">    printErr(WRONG_PARAMS);</a>
<a name="ln148">    return;</a>
<a name="ln149">  }</a>
<a name="ln150">  char *num = argv[1];</a>
<a name="ln151">  char *div = argv[2];</a>
<a name="ln152">  printf(&quot;%s/%s=%d\r\n&quot;, num, div, atoi(num) / atoi(div));</a>
<a name="ln153">}</a>
<a name="ln154"> </a>
<a name="ln155">static void time(int argc, char **argv) {</a>
<a name="ln156">  uint32_t secs = getSeconds();</a>
<a name="ln157">  uint32_t h = secs / 3600, m = secs % 3600 / 60, s = secs % 3600 % 60;</a>
<a name="ln158">  printf(&quot;%2d:%2d:%2d\r\n&quot;, h, m, s);</a>
<a name="ln159">}</a>
<a name="ln160"> </a>
<a name="ln161">static void fontSize(int argc, char **argv) {</a>
<a name="ln162">  if (argc != 2) {</a>
<a name="ln163">    printErr(WRONG_PARAMS);</a>
<a name="ln164">    return;</a>
<a name="ln165">  }</a>
<a name="ln166">  int s = atoi(argv[1]);</a>
<a name="ln167">  if (s &gt;= MIN_FONT_SIZE &amp;&amp; s &lt;= MAX_FONT_SIZE)</a>
<a name="ln168">    setFontSize((uint8_t)s);</a>
<a name="ln169">  else {</a>
<a name="ln170">    printErr(INVALID_FONT_SIZE);</a>
<a name="ln171">    puts(CHECK_MAN_FONT);</a>
<a name="ln172">  }</a>
<a name="ln173">}</a>
<a name="ln174"> </a>
<a name="ln175">static void printMem(int argc, char **argv) {</a>
<a name="ln176">  if (argc != 2) {</a>
<a name="ln177">    printErr(WRONG_PARAMS);</a>
<a name="ln178">    return;</a>
<a name="ln179">  }</a>
<a name="ln180">  uint8_t resp[QTY_BYTES];</a>
<a name="ln181">  char *end;</a>
<a name="ln182">  getMemory(strtoh(argv[1], &amp;end), resp);</a>
<a name="ln183">  for (int i = 0; i &lt; QTY_BYTES; i++) {</a>
<a name="ln184">    printf(&quot;0x%2x &quot;, resp[i]);</a>
<a name="ln185">    if (i % 4 == 3)</a>
<a name="ln186">      putchar('\n');</a>
<a name="ln187">  }</a>
<a name="ln188">}</a>
<a name="ln189"> </a>
<a name="ln190">static char *_regNames[] = {&quot;RIP&quot;, &quot;RSP&quot;, &quot;RAX&quot;, &quot;RBX&quot;, &quot;RCX&quot;, &quot;RDX&quot;,</a>
<a name="ln191">                            &quot;RBP&quot;, &quot;RDI&quot;, &quot;RSI&quot;, &quot;R8&quot;,  &quot;R9&quot;,  &quot;R10&quot;,</a>
<a name="ln192">                            &quot;R11&quot;, &quot;R12&quot;, &quot;R13&quot;, &quot;R14&quot;, &quot;R15&quot;};</a>
<a name="ln193">static void printInfoReg(int argc, char **argv) {</a>
<a name="ln194">  int len = sizeof(_regNames) / sizeof(char *);</a>
<a name="ln195">  uint64_t regSnapshot[len];</a>
<a name="ln196">  getInfoReg(regSnapshot);</a>
<a name="ln197">  for (int i = 0; i &lt; len; i++)</a>
<a name="ln198">    printf(&quot;%s: 0x%x\n&quot;, _regNames[i], regSnapshot[i]);</a>
<a name="ln199">}</a>
<a name="ln200"> </a>
<a name="ln201">static void man(int argc, char **argv) {</a>
<a name="ln202">  if (argc != 2) {</a>
<a name="ln203">    printErr(WRONG_PARAMS);</a>
<a name="ln204">    return;</a>
<a name="ln205">  }</a>
<a name="ln206">  int idx = getCommandIndex(argv[1]);</a>
<a name="ln207">  if (idx != -1)</a>
<a name="ln208">    printf(&quot;%s\n&quot;, usages[idx]);</a>
<a name="ln209">  else</a>
<a name="ln210">    printErr(INVALID_COMMAND);</a>
<a name="ln211">}</a>
</code></pre>
<div class="balloon" rel="92"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'scanf' function. The pointer to string of wchar_t type symbols is expected.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>