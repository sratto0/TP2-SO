<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>process.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is a personal academic project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java:</a>
<a name="ln3">// https://pvs-studio.com</a>
<a name="ln4"> </a>
<a name="ln5">#include &quot;process.h&quot;</a>
<a name="ln6">#include &quot;../../SharedLibraries/sharedStructs.h&quot;</a>
<a name="ln7">#include &quot;lib.h&quot;</a>
<a name="ln8">#include &quot;scheduler.h&quot;</a>
<a name="ln9">#include &lt;stdint.h&gt;</a>
<a name="ln10"> </a>
<a name="ln11">#define STACK_SIZE 0x1000</a>
<a name="ln12"> </a>
<a name="ln13">extern void *set_stack_frame(void (*wrapper)(entry_point_t, char **),</a>
<a name="ln14">                             entry_point_t main, void *stack_top, void *argv);</a>
<a name="ln15"> </a>
<a name="ln16">static char **duplicate_argv(char **argv);</a>
<a name="ln17">static int count_from_argv(char **argv);</a>
<a name="ln18">static uint32_t str_length(const char *str);</a>
<a name="ln19">static void free_partial_argv(char **argv, int allocated);</a>
<a name="ln20"> </a>
<a name="ln21">process_t *my_create_process(int64_t pid, entry_point_t entry_point,</a>
<a name="ln22">                             char **argv, char *name, int *fds) {</a>
<a name="ln23">  (void)fds;</a>
<a name="ln24"> </a>
<a name="ln25">  if (entry_point == NULL || name == NULL) {</a>
<a name="ln26">    return NULL;</a>
<a name="ln27">  }</a>
<a name="ln28"> </a>
<a name="ln29">  process_t *proc = (process_t *)memory_alloc(sizeof(process_t));</a>
<a name="ln30"> </a>
<a name="ln31">  if (proc == NULL) {</a>
<a name="ln32">    return NULL;</a>
<a name="ln33">  }</a>
<a name="ln34"> </a>
<a name="ln35">  memset(proc, 0, sizeof(*proc));</a>
<a name="ln36">  if(name){</a>
<a name="ln37">    my_strncpy(proc-&gt;name, name, MAX_NAME_LEN - 1);</a>
<a name="ln38">    proc-&gt;name[MAX_NAME_LEN - 1] = 0;</a>
<a name="ln39">  }</a>
<a name="ln40"> </a>
<a name="ln41">  proc-&gt;pid = pid;</a>
<a name="ln42">  proc-&gt;parent_pid = get_current_pid();</a>
<a name="ln43">  proc-&gt;waiting_pid = NO_PID;</a>
<a name="ln44">  proc-&gt;state = PROC_READY;</a>
<a name="ln45">  proc-&gt;in_ready_queue = 0;</a>
<a name="ln46">  proc-&gt;entry_point = entry_point;</a>
<a name="ln47">  proc-&gt;return_value = 0;</a>
<a name="ln48"> </a>
<a name="ln49">  proc-&gt;stack_base = memory_alloc(STACK_SIZE);</a>
<a name="ln50">  if (proc-&gt;stack_base == NULL) {</a>
<a name="ln51">    memory_free(proc);</a>
<a name="ln52">    return NULL;</a>
<a name="ln53">  }</a>
<a name="ln54"> </a>
<a name="ln55">  proc-&gt;stack_pointer = (uint8_t *)proc-&gt;stack_base + STACK_SIZE;</a>
<a name="ln56">  proc-&gt;stack_top = proc-&gt;stack_pointer;</a>
<a name="ln57"> </a>
<a name="ln58">  proc-&gt;argv = duplicate_argv(argv);</a>
<a name="ln59">  if (proc-&gt;argv == NULL) {</a>
<a name="ln60">    memory_free(proc-&gt;stack_base);</a>
<a name="ln61">    memory_free(proc);</a>
<a name="ln62">    return NULL;</a>
<a name="ln63">  }</a>
<a name="ln64"> </a>
<a name="ln65">  proc-&gt;argc = count_from_argv(proc-&gt;argv);</a>
<a name="ln66"> </a>
<a name="ln67">  proc-&gt;stack_pointer = set_stack_frame(&amp;process_caller, entry_point,</a>
<a name="ln68">                                        proc-&gt;stack_pointer, proc-&gt;argv);</a>
<a name="ln69"> </a>
<a name="ln70">  return proc;</a>
<a name="ln71">}</a>
<a name="ln72"> </a>
<a name="ln73">void process_destroy(process_t *proc) {</a>
<a name="ln74">  if (proc == NULL) {</a>
<a name="ln75">    return;</a>
<a name="ln76">  }</a>
<a name="ln77">  free_argv(proc-&gt;argv);</a>
<a name="ln78">  memory_free(proc-&gt;stack_base);</a>
<a name="ln79">  memory_free(proc);</a>
<a name="ln80">}</a>
<a name="ln81"> </a>
<a name="ln82">static char **duplicate_argv(char **argv) {</a>
<a name="ln83">  if (argv == NULL || argv[0] == NULL) {</a>
<a name="ln84">    char **new_argv = memory_alloc(sizeof(char *));</a>
<a name="ln85">    if (new_argv == NULL)</a>
<a name="ln86">      return NULL;</a>
<a name="ln87">    new_argv[0] = NULL;</a>
<a name="ln88">    return new_argv;</a>
<a name="ln89">  }</a>
<a name="ln90">  int count = count_from_argv(argv);</a>
<a name="ln91">  char **new_argv = memory_alloc((count + 1) * sizeof(char *));</a>
<a name="ln92">  if (new_argv == NULL)</a>
<a name="ln93">    return NULL;</a>
<a name="ln94">  for (int i = 0; i &lt; count; i++) {</a>
<a name="ln95">    uint32_t len = str_length(argv[i]) + 1;</a>
<a name="ln96">    new_argv[i] = memory_alloc(len);</a>
<a name="ln97">    if (new_argv[i] == NULL) {</a>
<a name="ln98">      free_partial_argv(new_argv, i);</a>
<a name="ln99">      memory_free(new_argv);</a>
<a name="ln100">      return NULL;</a>
<a name="ln101">    }</a>
<a name="ln102">    memcpy(new_argv[i], argv[i], len);</a>
<a name="ln103">  }</a>
<a name="ln104">  new_argv[count] = NULL;</a>
<a name="ln105">  return new_argv;</a>
<a name="ln106">}</a>
<a name="ln107"> </a>
<a name="ln108">static int count_from_argv(char **argv) {</a>
<a name="ln109">  int count = 0;</a>
<a name="ln110">  if (argv == NULL) {</a>
<a name="ln111">    return 0;</a>
<a name="ln112">  }</a>
<a name="ln113">  while (argv[count] != NULL) {</a>
<a name="ln114">    count++;</a>
<a name="ln115">  }</a>
<a name="ln116">  return count;</a>
<a name="ln117">}</a>
<a name="ln118"> </a>
<a name="ln119">void free_argv(char **argv) {</a>
<a name="ln120">  if (argv == NULL) {</a>
<a name="ln121">    return;</a>
<a name="ln122">  }</a>
<a name="ln123">  for (int i = 0; argv[i] != NULL; i++) {</a>
<a name="ln124">    memory_free(argv[i]);</a>
<a name="ln125">  }</a>
<a name="ln126">  memory_free(argv);</a>
<a name="ln127">}</a>
<a name="ln128"> </a>
<a name="ln129">void process_caller(entry_point_t main, char **argv) {</a>
<a name="ln130">  int count = count_from_argv(argv);</a>
<a name="ln131">  int64_t ret = main(count, argv);</a>
<a name="ln132">  my_exit(ret);</a>
<a name="ln133">}</a>
<a name="ln134"> </a>
<a name="ln135">static uint32_t str_length(const char *str) {</a>
<a name="ln136">  if (str == NULL) {</a>
<a name="ln137">    return 0;</a>
<a name="ln138">  }</a>
<a name="ln139">  uint32_t len = 0;</a>
<a name="ln140">  while (str[len] != 0) {</a>
<a name="ln141">    len++;</a>
<a name="ln142">  }</a>
<a name="ln143">  return len;</a>
<a name="ln144">}</a>
<a name="ln145"> </a>
<a name="ln146">static void free_partial_argv(char **argv, int allocated) {</a>
<a name="ln147">  if (argv == NULL) {</a>
<a name="ln148">    return;</a>
<a name="ln149">  }</a>
<a name="ln150">  for (int i = 0; i &lt; allocated; i++) {</a>
<a name="ln151">    if (argv[i] != NULL) {</a>
<a name="ln152">      memory_free(argv[i]);</a>
<a name="ln153">    }</a>
<a name="ln154">  }</a>
<a name="ln155">}</a>
</code></pre>
<div class="balloon" rel="36"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v547/" target="_blank">V547</a> Expression 'name' is always true.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>